
  {% extends "base2.html" %}

      {% block css %}
     <link rel="stylesheet" href="/static/css/bootstrap-datetimepicker.min.css" media="screen">
    {% endblock %}

   {% block content %}


  <div class="header">
            <h1 class="page-header">
                样本管理 <small>查看和添加样本</small>
            </h1>
        </div>
  <div id="page-inner">


            <div class="row">

                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            样本上传
                        </div>

                        <div class="panel-body">

                            <div class="alert alert-danger error-file" role="alert" style="display: none">请选择正确格式的文件</div>
                            <form>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group name-group">
                                            <label for="sampleName">样本名称</label>
                                            <input type="text" class="form-control" id="sampleName" placeholder="必填">
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group type-group">
                                            <label for="sampleType">样本类型</label>
                                            <input type="text" class="form-control" id="sampleType" placeholder="必填">
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group source-group">
                                            <label for="sampleSource">样本来源</label>
                                            <input type="text" class="form-control" id="sampleSource" placeholder="必填">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group extra-group">
                                            <label for="sampleExtra">样本备注</label>
                                            <input type="text" class="form-control" id="sampleExtra">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="sample">选择样本</label>
                                            <input type="file" class="form-control" id="sample">
                                        </div>
                                    </div>

                                    <div class="col-md-2 col-md-offset-4">
                                        <div class="form-group">
                                            <label></label>
                                            <button type="button" class="form-control btn btn-primary" id="upload_sample">提交样本</button>
                                        </div>
                                    </div>

                                    <div class="clearfix"></div>
                                </div>


                            </form>

                        </div>
                    </div>
                </div>
            </div>

            <div class="row">

                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            样本管理
                        </div>

                        <div class="panel-body">

                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    样本搜索
                                </div>

                                <div class="panel-body">
                                    <form>
                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label for="search-name">名称</label>
                                                    <input type="text" class="form-control" id="search-name">
                                                </div>
                                            </div>

                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label for="search-type">类型</label>
                                                    <input type="text" class="form-control" id="search-type">
                                                </div>
                                            </div>

                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label for="search-source">来源</label>
                                                    <input type="text" class="form-control" id="search-source">
                                                </div>
                                            </div>

                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label for="dtp_input1">起始时间</label>
                                                    <div class="input-group date form_datetime" data-date-format="dd MM yyyy - HH:ii p" data-link-field="dtp_input1">
                                                        <input class="form-control" size="16" type="text" value="" readonly>
                                                        <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                                                    </div>
                                                    <input type="hidden" id="dtp_input1" value="" /><br/>
                                                </div>
                                            </div>

                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label for="dtp_input2">终止时间</label>
                                                    <div class="input-group date form_datetime" data-date-format="dd MM yyyy - HH:ii p" data-link-field="dtp_input2">
                                                        <input class="form-control" size="16" type="text" value="" readonly>
                                                        <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                                                    </div>
                                                    <input type="hidden" id="dtp_input2" value="" /><br/>
                                                </div>
                                            </div>

                                        </div>

                                        <div class="row">
                                            <div class="col-md-2 col-md-offset-5">
                                                <div class="form-group">
                                                    <button type="submit" class="form-control btn btn-primary" >搜索</button>
                                                </div>
                                            </div>
                                        </div>

                                    </form>

                                </div>
                            </div>

                            <table class="table table-bordered" id="samples">
                                <thead>
                                    <tr>
                                        <th> 编号</th>
                                        <th> 名称</th>
                                        <th> 类型</th>
                                        <th> 来源</th>
                                        <th> 添加时间</th>
                                        <th> 备注</th>
                                        <th> 下载/删除</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>

                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modal1" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-4 col-md-offset-4">
                                    <h3>正在上传</h3>
                                </div>
                            </div>
                            <br/>
                            <br/>
                            <div class="row">
                                <div class="col-md-10 col-md-offset-1">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->
        </div>
  <!-- /. PAGE INNER  -->
  {% endblock %}


  {% block js %}
  <script src="/static/js/bootstrap-datetimepicker.min.js"></script>
    <script>
    $("#main-menu").find("li").find("a").eq(1).addClass("active-menu");

    $('.form_datetime').datetimepicker({
        //language:  'fr',
        weekStart: 1,
        todayBtn:  1,
        autoclose: 1,
        todayHighlight: 1,
        startView: 2,
        forceParse: 0,
        showMeridian: 1
    });

    $("#upload_sample").click(function () {
        var name = $("#sampleName").val();
        if(name === "") {
            $(".name-group").addClass("has-error");
            return;
        } else {
            $(".name-group").removeClass("has-error");
        }

        var type = $("#sampleType").val();
        if(type === "") {
            $(".type-group").addClass("has-error");
            return;
        } else {
            $(".type-group").removeClass("has-error");
        }

        var source = $("#sampleSource").val();
        if(source === "") {
            $(".source-group").addClass("has-error");
            return;
        }

        var sample = $("#sample");
        var val = sample.val().toLowerCase();
        var regex = new RegExp("(.*?)\.(ipa|apk|zip|appx)$");
        val = val.replace(/^.*[\\\/]/, '');
        if(sample.get(0).files.length === 0 || !regex.test(val)) {
            $(".error-file").attr("display", "inherit");
            return;
        } else {
            $(".error-file").attr("display", "none");
        }

        var extra = $("#sampleExtra").val();
        if(extra === "") {
            extra = "null";
        }
        var formData = new FormData();
        formData.append("name", name);
        formData.append("type", type);
        formData.append("source", source);
        formData.append("extra", extra);
        formData.append("file", sample.get(0).files[0]);
        $.ajax({
            type: 'POST',
            url: '../upload_sample/',
            headers: {
                "X-CSRFToken": '{{ csrf_token }}',
            },
            processData:false,
            contentType:false,
            data: formData,
            beforeSend: function() {
                $(".uploading").html("正在上传");
                $(".progress").show();
                $("#modal1").modal({backdrop: 'static', keyboard: false});
            },
            error: function() {
                console.log("error");
                $("#modal1").modal('toggle');
                //alert("网络错误”);
            },
            success: function(data) {
                $(".uploading").html("上传成功");
                $(".progress").hide();
                setTimeout(function () {
                    $("#modal1").modal('toggle');
                }, 1000);
                console.log(data);
                refreshList();
            }
        });

    });


    function refreshList() {
        $.ajax({
            type: 'GET',
            url: '../get_samples/',
            headers: {
                "X-CSRFToken": '{{ csrf_token }}',
            },
            error: function() {
                alert("网络错误!");
            },
            success: function(data) {
                $("#samples").find("tbody").find("tr").remove();
                for(var count = 0; count < data.samples.length; count++) {
                     no = count + 1;
                     i = data.samples[count];
                     $("#samples").find("tbody").append(
                     '<tr><th scope="row">' + no + '</th><td>' + i.name + '</td><td>' + i.type + '</td><td>' +
                     i.source + '</td><td>' + i.TS + '</td><td>' + i.extra + '</td><td><a href="../download/'+ i.md5 + '.apk">下载</a>/<a href="../delete_sample/?md5=' + i.md5 +'">删除</a></td></tr>');
                }
            }
        });
    }


    refreshList();
    </script>
  {% endblock %}